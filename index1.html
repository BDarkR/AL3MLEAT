<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تقرير العمليات - الميناء</title>
  <link href="./style.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --accent:#27ae60; --muted:#9b9b9b; }
    body{font-family:'Cairo',system-ui,Arial,sans-serif;background:#0b0b0b;color:#eee}
    .card{background:linear-gradient(#1a1a1a,#212121);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.6);}

    .section { margin-bottom:18px; border-top:1px dashed rgba(255,255,255,0.03); padding-top:12px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row label { min-width:160px; font-size:14px; color:#ddd; }
    .row .input { flex:1; margin-bottom:0; }
    .add-btn { background:transparent; color:var(--accent); border:1px dashed rgba(39,174,96,0.35); padding:6px 10px; border-radius:8px; cursor:pointer; }
    .controls { display:flex; gap:8px; margin-top:10px; }
    .report-output { width:100%; min-height:220px; resize:vertical; padding:12px; background:#222; color:#ddd; border-radius:8px; border:1px solid rgba(255,255,255,0.03); white-space:pre-wrap; direction:rtl; }
    .del-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#ff6b6b; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; }
    .role.duplicate { border-color:#e74c3c !important; color:#ffb3b3 !important; background:rgba(231,76,60,0.04); }
    .row label.duplicate-label { color:#ff6b6b !important; }
    #dupWarning { color:#ff6b6b; display:none; margin-top:8px; font-size:13px; }

    .player-wrap { display:flex; gap:6px; align-items:center; }
    .playerChk { width:18px; height:18px; }
    .playerMention { width:160px; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:#222; color:#ddd; display:none; font-size:13px; }
    .playerLabel { font-size:13px; color:#bbb; }

    /* header buttons style like screenshot */
    .top-nav { padding:12px 18px; }
    .top-nav nav { display:flex; gap:8px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
    .btn-pill {
      display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:6px 14px;
      height:34px; line-height:1; font-size:14px; border-radius:18px; font-weight:700; white-space:nowrap;
    }
    .btn-pill.outline { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .btn-pill.filled { background:var(--accent); color:#fff; border:1px solid var(--accent); }
    .small-note{ color:var(--muted); font-size:13px; margin-bottom:8px; text-align:right; }

    /* spacer row: visual gap in the form */
    .row.spacer { padding:0; margin:6px 0; }
  </style>
</head>
<body>
  <div class="bg-mark"></div>

  <header class="top-nav">
    <nav>
      <div class="btn-pill outline" aria-hidden="true">تقرير العمليات الميناء</div>
      <a class="btn-pill filled" href="https://boletofsf.odoo.com/" target="_blank" rel="noopener noreferrer">العودة إلى الموقع</a>
    </nav>
  </header>

  <main class="center-wrap">
    <section class="card" style="max-width:820px; width:96%;">
      <h1 id="pageTitle" class="title">تقرير العـــمـــلــيــات في الميناء</h1>
      <p id="pageSubtitle" class="subtitle">املأ الحقول ثم اضغط "انشاء التقرير"</p>

      <form id="reportForm" onsubmit="return false;">
        <div class="section">
          <!-- وقت الاستلام ثابت (الحقل موجود لكن سنمنع اضافة زر "لاعب" له) -->
          <div class="row">
            <label>وقت استلام الشفت</label>
            <input id="shiftTimeDisplay" class="input" value="6 صباحا" readonly />
          </div>

          <div class="row">
            <label>العمليات (منشن)</label>
            <input id="operations" class="input" placeholder="@" />
          </div>
          <div class="row">
            <label>نائب العمليات (منشن)</label>
            <input id="opsDeputy" class="input" placeholder="@" />
          </div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 8px;color:var(--accent);font-size:16px">القيادة العامة</h3>

          <div class="row"><label>قائد امن المنشأت</label><input class="input role" data-role="قائد امن المنشأت" placeholder="H-000" value="H-000"/></div>

          <div class="row"><label>نائب قائد امن المنشأت</label><input class="input role" data-role="نائب قائد امن المنشأت" placeholder="H-000" value="H-000"/></div>
        </div>

        <div class="section" id="leadershipSection">
          <h3 style="margin:0 0 8px;color:var(--accent);font-size:16px">القيادة (يمكن إضافة أكثر)</h3>
          <div id="leadershipList">
            <div class="row"><label>قيادة 1</label><input class="input role" data-role="قيادة 1" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>قيادة 2</label><input class="input role" data-role="قيادة 2" placeholder="H-000" value="H-000"/></div>
          </div>
          <button type="button" class="add-btn" data-target="leadershipList">＋ إضافة قيادة</button>

          <div style="margin-top:10px;">
            <div class="row">
              <label>ضابط خفر</label>
              <!-- تم تغيير القيمة الافتراضية إلى H-000 كما طلبت -->
              <input id="dhInput" class="input role" data-role="ضابط خفر" placeholder="H-000" value="H-000"/>
            </div>
          </div>
        </div>

        <div class="section" id="unitsSection">
          <h3 style="margin:0 0 8px;color:var(--accent);font-size:16px">الوحدات (قابلة للإضافة)</h3>

          <div style="margin-top:6px;">
            <h4 style="margin:0 0 8px;color:#ccc;font-size:15px">ردع (قابل للإضافة)</h4>
            <div id="radaList">
              <div class="row"><label>ردع 1</label>
                <input class="input role" data-role="ردع 1" placeholder="H-000" value="H-000"/>
              </div>
              <div class="row"><label>ردع 2</label>
                <input class="input role" data-role="ردع 2" placeholder="H-000" value="H-000"/>
              </div>
            </div>
            <button type="button" class="add-btn" data-target="radaList">＋ إضافة ردع</button>
          </div>

          <div style="margin-top:12px;">
            <h4 style="margin:0 0 8px;color:#ccc;font-size:15px">برق (قابل للإضافة)</h4>
            <div id="barqList">
              <div class="row"><label>برق 1</label>
                <input class="input role" data-role="برق 1" placeholder="H-000" value="H-000"/>
              </div>
              <div class="row"><label>برق 2</label>
                <input class="input role" data-role="برق 2" placeholder="H-000" value="H-000"/>
              </div>
            </div>
            <button type="button" class="add-btn" data-target="barqList">＋ إضافة برق</button>
          </div>

          <div style="margin-top:12px;">
            <h4 style="margin:0 0 8px;color:#ccc;font-size:15px">سهم</h4>
            <div id="sahmList">
              <div class="row"><label>سهم 1</label>
                <input class="input role" data-role="سهم 1" placeholder="H-000" value="H-000"/>
              </div>
              <div class="row"><label>سهم 2</label>
                <input class="input role" data-role="سهم 2" placeholder="H-000" value="H-000"/>
              </div>
            </div>
          </div>

          <!-- مشرفو الأمن وفرقهم -->
          <div style="margin:12px 0;">
            <h4 style="margin:0 0 8px;color:#ccc;font-size:15px">مشرفو الأمن</h4>
            <div id="securitySupervisors">
              <div class="row"><label>مشرف أمن 1</label><input class="input role" data-role="مشرف أمن 1" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>أمن 1</label><input class="input role" data-role="أمن 1" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>مساندة أمن 1</label><input class="input role" data-role="مساندة أمن 1" placeholder="H-000" value="H-000"/></div>

              <!-- spacer row -->
              <div class="row spacer" aria-hidden="true"><div style="flex:1;height:10px"></div></div>

              <div class="row"><label>مشرف أمن 2</label><input class="input role" data-role="مشرف أمن 2" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>أمن 2</label><input class="input role" data-role="أمن 2" placeholder="H-000" value="H-000"/></div>
            </div>
          </div>

          <!-- مجموعة "حرة (قابل للإضافة)" مع زر إضافة -->
          <div style="margin:12px 0;">
            <h4 style="margin:0 0 8px;color:#ccc;font-size:15px">حرة <span style="color:#9b9b9b;font-size:13px;margin-left:8px">(قابل للإضافة)</span></h4>
            <div id="huraList">
              <div class="row"><label>حرة 1</label><input class="input role" data-role="حرة 1" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>حرة 2</label><input class="input role" data-role="حرة 2" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>حرة 3</label><input class="input role" data-role="حرة 3" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>حرة 4</label><input class="input role" data-role="حرة 4" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>حرة 5</label><input class="input role" data-role="حرة 5" placeholder="H-000" value="H-000"/></div>
            </div>
            <button type="button" class="add-btn" data-target="huraList">＋ إضافة حرة</button>
          </div>

          <div style="margin:12px 0;">
            <h4 style="margin:0 0 8px;color:#ccc;font-size:15px">صقر (قابل للإضافة)</h4>
            <div id="saqrList">
              <div class="row"><label>صقر 1</label><input class="input role" data-role="صقر 1" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>صقر 2</label><input class="input role" data-role="صقر 2" placeholder="H-000" value="H-000"/></div>
            </div>
            <button type="button" class="add-btn" data-target="saqrList">＋ إضافة صقر</button>
          </div>

          <div style="margin-top:12px;">
            <div class="row"><label>شرطة عسكرية</label><input class="input role" data-role="شرطة عسكرية" placeholder="H-000" value="H-000"/></div>
          </div>

          <div style="margin-top:12px;">
            <div id="coastalList">
              <div class="row"><label>عين 1</label><input class="input role" data-role="عين 1" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>ساحل 1</label><input class="input role" data-role="ساحل 1" placeholder="H-000" value="H-000"/></div>
              <div class="row"><label>سجن 1</label><input class="input role" data-role="سجن 1" placeholder="H-000" value="H-000"/></div>
            </div>
          </div>
        </div>

        <div class="section" id="specialForcesSection">
          <h3 style="margin:0 0 8px;color:var(--accent);font-size:16px">القوات الخاصة</h3>
          <div id="specialForcesList">
            <div class="row"><label>قائد فرقة القوات الخاصة</label><input class="input role" data-role="قائد فرقة القوات الخاصة" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>نائب الفرقة</label><input class="input role" data-role="نائب الفرقة" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>حزم 1</label><input class="input role" data-role="حزم 1" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>رمح 1</label><input class="input role" data-role="رمح 1" placeholder="H-000" value="H-000"/></div>
          </div>
        </div>

        <div class="section" id="criminalSection">
          <h3 style="margin:0 0 8px;color:var(--accent);font-size:16px">البحث الجنائي</h3>
          <div id="criminalList">
            <div class="row"><label>قائد فرقة البحث الجنائي</label><input class="input role" data-role="قائد فرقة البحث الجنائي" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>نائب الفرقة</label><input class="input role" data-role="نائب الفرقة" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>جنائي 1</label><input class="input role" data-role="جنائي 1" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>جنائي 2</label><input class="input role" data-role="جنائي 2" placeholder="H-000" value="H-000"/></div>
          </div>
        </div>

        <div class="section" id="securitySection">
          <h3 style="margin:0 0 8px;color:var(--accent);font-size:16px">الأمن والحماية</h3>
          <div id="securityList">
            <div class="row"><label>حماية 1</label><input class="input role" data-role="حماية 1" placeholder="H-000" value="H-000"/></div>
            <div class="row"><label>حماية 2</label><input class="input role" data-role="حماية 2" placeholder="H-000" value="H-000"/></div>
          </div>
        </div>

        <div id="dupWarning">هناك أكواد مكررة — تم تمييزها باللون الأحمر</div>

        <div class="controls">
          <button type="button" id="buildReport" class="btn primary" style="flex:1">انشاء التقرير</button>
          <button type="button" id="copyReport" class="btn secondary" style="width:150px;display:none">نسخ التقرير</button>
        </div>

        <div style="margin-top:12px;">
          <textarea id="reportOutput" class="report-output" placeholder="سيظهر التقرير هنا بعد الضغط"></textarea>
        </div>
      </form>
    </section>
  </main>

  <script>
    // Roles / rows that MUST NOT get a "لاعب" checkbox
    const EXCLUDED_LABELS = [
      'قائد امن المنشأت',
      'نائب قائد امن المنشأت',
      'وقت استلام الشفت' // تم استبعاد صف وقت الاستلام من الحصول على زر "لاعب"
    ];
    // labels that start with this prefix should be excluded (قيادة ...)
    const EXCLUDE_PREFIXES = ['قيادة'];

    // IDs of inputs that should never have player checkbox
    const EXCLUDED_INPUT_IDS = ['operations', 'opsDeputy', 'shiftTimeDisplay'];

    // add player-wrap (checkbox + mention) to a given .row if allowed
    function addPlayerWrapToRowIfAllowed(row) {
      if (!row || !(row instanceof HTMLElement)) return;
      if (row.querySelector('.player-wrap')) return; // already present

      // detect label text (if any) and input id/data-role
      const lblEl = row.querySelector('label');
      const labelText = lblEl ? (lblEl.textContent || '').trim() : '';
      const roleInput = row.querySelector('input.role');

      // if there's any input with an excluded id, don't add
      const inputs = Array.from(row.querySelectorAll('input'));
      for (const inp of inputs) {
        if (inp.id && EXCLUDED_INPUT_IDS.includes(inp.id)) return;
      }
      // exclude by explicit labels
      if (EXCLUDED_LABELS.includes(labelText)) return;
      // exclude "قيادة ..." prefix
      for (const p of EXCLUDE_PREFIXES) {
        if (labelText.startsWith(p)) return;
      }

      // Also exclude if the label is 'العمليات' or 'نائب العمليات'
      if (labelText === 'العمليات' || labelText === 'نائب العمليات') return;

      // At this point we allow adding the player controls
      const playerWrap = document.createElement('div');
      playerWrap.className = 'player-wrap';
      const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'playerChk'; chk.title = 'لاعب معتمد';
      const span = document.createElement('span'); span.className = 'playerLabel'; span.textContent = 'لاعب';
      const mention = document.createElement('input'); mention.className = 'playerMention'; mention.placeholder = '@player'; mention.style.display='none';
      playerWrap.appendChild(chk);
      playerWrap.appendChild(span);
      playerWrap.appendChild(mention);

      // insert before any existing delete button if present, otherwise append
      const delBtn = row.querySelector('.del-btn');
      if (delBtn) row.insertBefore(playerWrap, delBtn);
      else row.appendChild(playerWrap);

      // bind events for the newly created controls
      bindPlayerToggle(row);
    }

    // Helper: show/hide player mention input when checkbox toggled
    function bindPlayerToggle(row) {
      const chk = row.querySelector('.playerChk');
      const mention = row.querySelector('.playerMention');
      const codeInput = row.querySelector('.role');
      if (!chk || !mention) return;
      // avoid double-binding
      if (chk.dataset.bound === '1') return;
      chk.addEventListener('change', () => {
        if (chk.checked) {
          mention.style.display = 'inline-block';
          if (codeInput) codeInput.classList.remove('duplicate');
          const lbl = row.querySelector('label');
          if (lbl) lbl.classList.remove('duplicate-label');
        } else {
          mention.style.display = 'none';
        }
        checkDuplicates();
      });
      mention.addEventListener('input', checkDuplicates);
      chk.dataset.bound = '1';
    }

    function attachRoleListener(input) {
      if (!input) return;
      if (input.dataset.listenerAttached === '1') return;
      input.addEventListener('input', checkDuplicates);
      input.dataset.listenerAttached = '1';
    }

    // Attach listeners and add player-wraps where appropriate on initial load
    document.querySelectorAll('.row').forEach(row => {
      const roleInp = row.querySelector('.role');
      if (roleInp) attachRoleListener(roleInp);
    });

    // Add player checkbox to all eligible rows (initial pass)
    function addPlayerToAllEligibleRows() {
      document.querySelectorAll('.row').forEach(row => addPlayerWrapToRowIfAllowed(row));
      // ensure top-level operations and shift rows are not given player (explicitly remove if present)
      const opRow = document.getElementById('operations') ? document.getElementById('operations').closest('.row') : null;
      const deputyRow = document.getElementById('opsDeputy') ? document.getElementById('opsDeputy').closest('.row') : null;
      const shiftRow = document.getElementById('shiftTimeDisplay') ? document.getElementById('shiftTimeDisplay').closest('.row') : null;
      if (opRow) {
        const pw = opRow.querySelector('.player-wrap');
        if (pw) pw.remove();
      }
      if (deputyRow) {
        const pw = deputyRow.querySelector('.player-wrap');
        if (pw) pw.remove();
      }
      if (shiftRow) {
        const pw = shiftRow.querySelector('.player-wrap');
        if (pw) pw.remove(); // هنا: أزلنا زر "لاعب" من صف وقت الاستلام
      }
    }

    // createRow used by add buttons
    function createRow(labelText, dataRole, targetId) {
      const row = document.createElement('div');
      row.className = 'row';
      const label = document.createElement('label');
      label.textContent = labelText;
      const input = document.createElement('input');
      input.className = 'input role';
      input.setAttribute('data-role', dataRole);
      input.placeholder = 'H-000';
      input.value = 'H-000';

      const del = document.createElement('button'); del.type = 'button'; del.className = 'del-btn'; del.textContent = 'حذف';
      del.addEventListener('click', () => { row.remove(); checkDuplicates(); });

      row.appendChild(label);
      row.appendChild(input);
      row.appendChild(del);

      attachRoleListener(input);
      // add player-wrap if allowed for this new row
      addPlayerWrapToRowIfAllowed(row);

      return row;
    }

    document.querySelectorAll('.add-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const list = document.getElementById(targetId);
        if (!list) return;
        const existing = list.querySelectorAll('.row').length;
        const index = existing + 1;
        let baseName = '';
        const firstLabel = list.querySelector('.row label');
        if (firstLabel) baseName = firstLabel.textContent.split(' ')[0] || 'عنصر';
        else baseName = 'عنصر';
        const labelText = baseName + ' ' + index;
        const newRow = createRow(labelText, labelText, targetId);
        list.appendChild(newRow);
        checkDuplicates();
      });
    });

    function checkDuplicates() {
      const inputs = Array.from(document.querySelectorAll('.role'));
      const map = new Map();
      inputs.forEach(inp => {
        const row = inp.closest('.row');
        const playerChk = row ? row.querySelector('.playerChk') : null;
        if (playerChk && playerChk.checked) return;
        const v = (inp.value || '').trim().toUpperCase();
        if (!v || v === 'H-000' || v.startsWith('@')) return;
        if (!map.has(v)) map.set(v, []);
        map.get(v).push({ inp, row });
      });

      document.querySelectorAll('.role').forEach(inp => {
        inp.classList.remove('duplicate');
        const lbl = inp.parentElement.querySelector('label') || inp.closest('.row').querySelector('label');
        if (lbl) lbl.classList.remove('duplicate-label');
      });
      document.getElementById('dupWarning').style.display = 'none';

      let dupFound = false;
      map.forEach(arr => {
        if (arr.length > 1) {
          dupFound = true;
          arr.forEach(obj => {
            obj.inp.classList.add('duplicate');
            const lbl = obj.row.querySelector('label');
            if (lbl) lbl.classList.add('duplicate-label');
          });
        }
      });

      if (dupFound) document.getElementById('dupWarning').style.display = 'block';
    }

    const observer = new MutationObserver(muts => {
      muts.forEach(m => {
        m.addedNodes.forEach(node => {
          if (!(node instanceof HTMLElement)) return;
          // ensure newly added rows get player-wrap if allowed and have listeners attached
          node.querySelectorAll && node.querySelectorAll('.role').forEach(attachRoleListener);
          node.querySelectorAll && node.querySelectorAll('.row').forEach(r => {
            addPlayerWrapToRowIfAllowed(r);
            bindPlayerToggle(r);
          });
        });
      });
    });
    observer.observe(document.body, { childList: true, subtree: true });

    function appendFromContainer(containerId, out, addBlankAfter = true) {
      const container = document.getElementById(containerId);
      if (!container) return;
      const rows = container.querySelectorAll('.row');
      rows.forEach(row => {
        // if this row is a spacer, insert a blank line in the output
        if (row.classList && row.classList.contains('spacer')) {
          out.push('');
          return;
        }

        const roleName = (row.querySelector('label') || {}).textContent || '';
        const codeInput = row.querySelector('.role');
        const playerChk = row.querySelector('.playerChk');
        const mention = row.querySelector('.playerMention');

        let val = 'H-000';
        if (playerChk && playerChk.checked) {
          const raw = (mention && mention.value) ? mention.value.trim() : '';
          if (raw) val = raw.startsWith('@') ? raw : ('@' + raw);
          else val = '@';
        } else if (codeInput) {
          val = (codeInput.value && codeInput.value.trim()) ? codeInput.value.trim() : 'H-000';
        }

        if (roleName) out.push(roleName + ' : ' + val);
      });
      if (addBlankAfter) out.push('');
    }

    // coastal simple: عين, ساحل, سجن with gaps
    function appendCoastalWithGaps(out) {
      const container = document.getElementById('coastalList');
      if (!container) return;
      const rows = Array.from(container.querySelectorAll('.row'));
      const ayn = rows.filter(r => (r.querySelector('label')||{}).textContent.trim().startsWith('عين'));
      const sah = rows.filter(r => (r.querySelector('label')||{}).textContent.trim().startsWith('ساحل'));
      const sijn = rows.filter(r => (r.querySelector('label')||{}).textContent.trim().startsWith('سجن'));

      ayn.forEach(row => {
        const roleName = (row.querySelector('label')||{}).textContent || '';
        const codeInput = row.querySelector('.role');
        const playerChk = row.querySelector('.playerChk');
        const mention = row.querySelector('.playerMention');
        let val = 'H-000';
        if (playerChk && playerChk.checked) {
          const raw = (mention && mention.value) ? mention.value.trim() : '';
          val = raw ? (raw.startsWith('@') ? raw : ('@' + raw)) : '@';
        } else if (codeInput) {
          val = (codeInput.value && codeInput.value.trim()) ? codeInput.value.trim() : 'H-000';
        }
        out.push(roleName + ' : ' + val);
      });
      if (ayn.length) out.push('');

      sah.forEach(row => {
        const roleName = (row.querySelector('label')||{}).textContent || '';
        const codeInput = row.querySelector('.role');
        const playerChk = row.querySelector('.playerChk');
        const mention = row.querySelector('.playerMention');
        let val = 'H-000';
        if (playerChk && playerChk.checked) {
          const raw = (mention && mention.value) ? mention.value.trim() : '';
          val = raw ? (raw.startsWith('@') ? raw : ('@' + raw)) : '@';
        } else if (codeInput) {
          val = (codeInput.value && codeInput.value.trim()) ? codeInput.value.trim() : 'H-000';
        }
        out.push(roleName + ' : ' + val);
      });
      if (sah.length) out.push('');

      sijn.forEach(row => {
        const roleName = (row.querySelector('label')||{}).textContent || '';
        const codeInput = row.querySelector('.role');
        const playerChk = row.querySelector('.playerChk');
        const mention = row.querySelector('.playerMention');
        let val = 'H-000';
        if (playerChk && playerChk.checked) {
          const raw = (mention && mention.value) ? mention.value.trim() : '';
          val = raw ? (raw.startsWith('@') ? raw : ('@' + raw)) : '@';
        } else if (codeInput) {
          val = (codeInput.value && codeInput.value.trim()) ? codeInput.value.trim() : 'H-000';
        }
        out.push(roleName + ' : ' + val);
      });
    }

    // build report tuned to the requested output example
    function buildReportText() {
      checkDuplicates();
      const out = [];
      const shiftLabel = 'الميناء';
      const timeLabel = '6 صباحا';

      out.push('تقرير العـــمـــلــيــات في ' + shiftLabel);
      out.push('');
      out.push('تم استلام عمليات ' + shiftLabel + ' في تمام الساعه ' + timeLabel);
      out.push('');

      const rawOps = (document.getElementById('operations').value || '').trim();
      const rawOpsDeputy = (document.getElementById('opsDeputy').value || '').trim();
      const operations = rawOps ? (rawOps.startsWith('@') ? rawOps : ('@' + rawOps)) : '@';
      const opsDeputy = rawOpsDeputy ? (rawOpsDeputy.startsWith('@') ? rawOpsDeputy : ('@' + rawOpsDeputy)) : '@';

      out.push('العمليات : ' + operations);
      out.push('نائب العمليات : ' + opsDeputy);
      out.push('');

      // قائد امن المنشأت & نائب
      const leader1 = document.querySelector('input[data-role="قائد امن المنشأت"]');
      const leader2 = document.querySelector('input[data-role="نائب قائد امن المنشأت"]');
      if (leader1) out.push(leader1.getAttribute('data-role') + ' : ' + ((leader1.value && leader1.value.trim()) ? leader1.value.trim() : 'H-000'));
      if (leader2) out.push(leader2.getAttribute('data-role') + ' : ' + ((leader2.value && leader2.value.trim()) ? leader2.value.trim() : 'H-000'));
      out.push('');

      // قيادة 1/2
      appendFromContainer('leadershipList', out);

      // ضابط خفر (default H-000 now)
      const dh = document.querySelector('input[data-role="ضابط خفر"]');
      if (dh) {
        const row = dh.closest('.row');
        const playerChk = row ? row.querySelector('.playerChk') : null;
        const mention = row ? row.querySelector('.playerMention') : null;
        let val = (dh.value && dh.value.trim()) ? dh.value.trim() : 'H-000';
        if (playerChk && playerChk.checked) {
          const raw = (mention && mention.value) ? mention.value.trim() : '';
          val = raw ? (raw.startsWith('@') ? raw : ('@' + raw)) : '@';
        }
        out.push(dh.getAttribute('data-role') + ' : ' + val);
        out.push('');
      }

      // ردع
      appendFromContainer('radaList', out);

      // برق
      appendFromContainer('barqList', out);

      // سهم
      appendFromContainer('sahmList', out);

      // مشرفو الأمن وفرقهم
      appendFromContainer('securitySupervisors', out);

      // حرة 1..n
      appendFromContainer('huraList', out);

      // صقر 1..2
      appendFromContainer('saqrList', out);

      // شرطة عسكرية
      const police = document.querySelector('input[data-role="شرطة عسكرية"]');
      if (police) {
        const row = police.closest('.row');
        const playerChk = row ? row.querySelector('.playerChk') : null;
        const mention = row ? row.querySelector('.playerMention') : null;
        let val = (police.value && police.value.trim()) ? police.value.trim() : 'H-000';
        if (playerChk && playerChk.checked) {
          const raw = (mention && mention.value) ? mention.value.trim() : '';
          val = raw ? (raw.startsWith('@') ? raw : ('@' + raw)) : '@';
        }
        out.push(police.getAttribute('data-role') + ' : ' + val);
        out.push('');
      }

      // البحث الجنائي (as heading)
      out.push('البحث الجنائي');
      appendFromContainer('criminalList', out);

      // القوات الخاصة
      out.push('');
      out.push('القوات الخاصة');
      appendFromContainer('specialForcesList', out);

      // الأمن والحماية
      out.push('');
      out.push('الأمن والحماية');
      appendFromContainer('securityList', out);

      // coastal groups with gaps
      appendCoastalWithGaps(out);

      // trim trailing blank lines
      while (out.length && out[out.length - 1] === '') out.pop();
      return out.join('\n');
    }

    const buildBtn = document.getElementById('buildReport');
    const copyBtn = document.getElementById('copyReport');
    const output = document.getElementById('reportOutput');

    buildBtn.addEventListener('click', () => {
      const text = buildReportText();
      output.value = text;
      copyBtn.style.display = 'inline-block';
      output.focus();
      output.select();
    });

    copyBtn.addEventListener('click', async () => {
      if (!output.value) return alert('لا يوجد تقرير لنسخه');
      try {
        await navigator.clipboard.writeText(output.value);
        copyBtn.textContent = 'تم النسخ ✓';
        setTimeout(() => copyBtn.textContent = 'نسخ التقرير', 1500);
      } catch (e) {
        alert('فشل النسخ — جرّب يدوياً');
      }
    });

    // initial setup: add player checkbox to all eligible rows and attach listeners
    addPlayerToAllEligibleRows();
    // initial duplicate check pass
    checkDuplicates();
  </script>
</body>
</html>